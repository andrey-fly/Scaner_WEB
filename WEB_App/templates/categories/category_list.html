{% extends 'base/base.html' %}
{% load static %}

{% block title %}
<title>{{category}}</title>
{% endblock %}

{% block extra_css%}
<link rel="stylesheet" type="text/css" href="{% static 'css/categories.css'%}">
<style>
    .btn-back {
        margin: 30px auto;
        width: 200px;
        font-size: 1.5rem;
        display: block;
    }

</style>
{% endblock %}

{% block content %}

<div class="card-list-group">
    {% for category in children %}
    <div class="card">
        {%if category.file%}
        <a href="/category/{{category.url_name}}"><img src="{{category.file}}" class="card-img-top"
                                                       alt="{{category.name}}"></a>
        {%else%}
        <h5 class="text-wrap p-5">Image not found</h5>
        {%endif%}
        <div class="card-body" style="width: inherit;">
            <h5 class="card-title text-center"><a href="/category/{{category.url_name}}" style="font-size: inherit">{{category.name}}</a>
            </h5>
            {% if user.is_superuser %}
            {% include 'modals_for_admin/edit_category.html' %}
            {% include 'modals_for_admin/add_child_category.html' %}
            {% include 'modals_for_admin/add_good_in_category.html' %}

            <form action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="category_delete">
                <input type="hidden" name="category_id" value="{{category.id}}">
                <input name="type" value="category" type="hidden">
                <button type="submit" class="btn btn-block btn-outline-danger mt-3">Удалить</button>
            </form>
            {% endif %}
        </div>
    </div>


    {% endfor %}

    {% for product in goods %}
    <div class="card">
        {%if product.file%}
        <a href="/product/{{product.name}}/"><img src="{{product.file}}" class="card-img-top" alt="{{product.name}}"></a>
        {%else%}
        <h5 class="text-wrap p-5">Image not found</h5>
        {%endif%}
        <div class="card-body">
            {% if user.is_authenticated %}

            {% for rate in rated %}
                {% for item in rate %}
                    <p style="margin: 0 auto;">Ваша оценка:</p>
                    {% if item.good == product.name %}
                        <p id="average-{{item.good}}" style="color: #10c46a; margin: 0 auto; font-size: 20px;">{{item.rating}}</p>
                        <script>
                            if ($('#average-{{item.good}}').html() <= 3.5)
                                $('#average').css('color', '#bf0704');
                            else
                                $('#average').css('color', '#10c46a');
                        </script>
                    {% else %}
                    <p style="margin: 5px auto; text-align: center; font-size: 17px">Кажется, вы ещё не оценили этот товар</p>
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% else %}

            {% for rate in rated %}
                {% if rate.good == product.name %}
                    <p style="margin: 0 auto;">оценка:</p>
                    <p id="average-{{rate.good}}" style="color: #10c46a; margin: 0 auto; font-size: 20px;">{%if rate.rating.rating__avg%}
                        {{rate.rating.rating__avg}} {%else%}0{%endif%}</p>
                {%endif%}
            {% endfor %}

            {% endif %}

            <h5 class="card-title text-center"><a href="/product/{{product.name}}/" style="font-size: inherit">{{product.name}}</a>
            </h5>

            {% if user.is_superuser %}
            {% include '../modals_for_admin/edit_good.html' %}
            {% include '../modals_for_admin/edit_positives.html' %}
            {% include '../modals_for_admin/edit_negatives.html' %}

            <form action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="good_id" value="{{product.id}}">
                <input name="type" value="good" type="hidden">
                <button type="submit" class="btn btn-block btn-outline-danger mt-4">Удалить</button>
            </form>

            {% endif %}

        </div>
    </div>
    {% endfor %}


    {% if not children and not goods %}
    <h3 class="p-5 text-danger">Элементы не найдены</h3>
    {% endif %}

</div>
<button type="button" class="btn btn-outline-primary btn-lg btn-back" onclick="go_back();"><span class="text-center">Назад</span>
</button>

{% endblock %}

{% block extra_js%}
<script>
    function go_back(){
        window.location.replace("{{prev}}");
    }
</script>
{% endblock %}
